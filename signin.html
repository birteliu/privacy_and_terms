<!doctype html>
<html>

<head>
  <title>Sign In - Webduino Device</title>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <link rel="icon" href="webduino.ico" type="image/x-icon">
  <link rel="stylesheet" href="components/bootstrap/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="css/font-awesome.min.css">
  <link rel="stylesheet" href="css/social-buttons.css">
  <!-- build:css -->
  <link rel="stylesheet/less" type="text/css" href="css/signin.less" />
  <script src="//cdnjs.cloudflare.com/ajax/libs/less.js/2.5.3/less.min.js"></script>
  <!-- endbuild -->
</head>

<body>
  <div class="container">
    <!-- singin box -->
    <div id="signinbox" class="mainbox">
      <div class="panel panel-info">
        <div class="panel-heading">
          <div class="panel-title">Sign In</div>
          <!-- <div class="forgot"><a href="#">Forgot password?</a></div> -->
        </div>
        <div class="panel-body">
          <div style="display:none" id="signinalert" class="alert alert-danger col-sm-12"></div>
          <form id="signinform" class="form-horizontal" role="form" onsubmit="return false">
            <div class="input-group">
              <span class="input-group-addon"><i class="glyphicon glyphicon-envelope"></i></span>
              <input required="true" id="signin-username" type="email" class="form-control" name="username" value="" placeholder="Email Address" autofocus>
            </div>
            <div class="input-group">
              <span class="input-group-addon"><i class="glyphicon glyphicon-lock"></i></span>
              <input required="true" id="signin-password" type="password" class="form-control" name="password" placeholder="Password">
            </div>
            <div class="input-group remember">
              <div class="checkbox">
                <label>
                  <input id="signin-remember" type="checkbox" name="remember" value="1"> Remember me
                </label>
              </div>
            </div>
            <div style="margin-top:10px" class="form-group ">
              <div class="col-sm-12 controls">
                <button id="btn-signin" type="submit" class="btn btn-success"> Sign in</button>
                <span style="margin:8px;">or</span>
                <div class="btn-group">
                  <a class='btn btn-danger disabled'><i class="fa fa-google-plus" style="width:16px; height:16px"></i>&nbsp;</a>
                  <a class='btn btn-danger' href='/auth/google' style="width:12em;"> Sign in with Google</a>
                </div>
              </div>
            </div>
            <div><a href="#" onClick="toggleResetPass()">Lost your password?</a></div>
            <div style="margin-top: 15px;">我同意 Webduino <a href="terms.html">使用條款</a> 和 <a href="privacy.html">隱私權政策</a></div>
          </form>
        </div>
        <div class="form-group goto-signup">
          <div class="col-md-12 control">
            <div>
              Don't have an account?
              <a href="#" onClick="toggleSignUp()">Sign Up Here!</a>
            </div>
          </div>
        </div>
      </div>
    </div><!-- /signin box -->

    <!-- singup box -->
    <div id="signupbox" class="mainbox">
      <div class="panel panel-info">
        <div class="panel-heading">
          <div class="panel-title">Sign Up</div>
        </div>
        <div class="panel-body">
          <form id="signupform" class="form-horizontal" role="form" onsubmit="return false">
            <div id="signupalert" style="display:none" class="alert alert-danger"></div>
            <div class="input-group">
              <span class="input-group-addon"><i class="glyphicon glyphicon-envelope"></i></span>
              <input id="signup-email" required="true" type="email" class="form-control" name="email" placeholder="Email Address">
            </div>
            <div class="input-group hidden">
              <span class="input-group-addon"><i class="glyphicon glyphicon-user"></i></span>
              <input id="signup-firstname" type="text" class="form-control" name="firstname" placeholder="First Name">
            </div>
            <div class="input-group hidden">
              <span class="input-group-addon"><i class="glyphicon glyphicon-hand-right"></i></span>
              <input id="signup-lastname" type="text" class="form-control" name="lastname" placeholder="Last Name">
            </div>
            <div class="input-group">
              <span class="input-group-addon"><i class="glyphicon glyphicon-lock"></i></span>
              <input id="signup-passwd" required="true" type="password" class="form-control" name="passwd" placeholder="Password">
            </div>
            <div id="recaptchaDiv"></div>
            <br />
            <button id="btn-signup" type="submit" class="btn btn-info"> Sign Up</button>
          </form>
        </div>
        <div class="form-group goto-signin">
          <div class="col-md-12 control">
            <div>
              Already have an account,
              <a href="#" onclick="toggleSignIn()">Sign In Here!</a>
            </div>
          </div>
        </div>
      </div>
    </div><!-- /signup box -->

    <!-- reset password -->
    <div id="resetpass" class="mainbox">
      <div class="panel panel-info">
        <div class="panel-heading">
          <div class="panel-title">Reset Password</div>
        </div>
        <div class="panel-body">
          <form id="resetform" class="form-horizontal" role="form" onsubmit="return false">
            <div id="resetalert" style="display:none" class="alert alert-danger"></div>
            <div class="input-group">
              <span class="input-group-addon"><i class="glyphicon glyphicon-envelope"></i></span>
              <input id="reset-email" required="true" type="email" class="form-control" name="email" placeholder="Email Address">
            </div>
            <button id="btn-reset" type="submit" class="btn btn-info">Submit</button>
          </form>
        </div>
        <div class="form-group goto-signin">
          <div class="col-md-12 control">
            <div>
              Already have an account,
              <a href="#" onclick="toggleSignIn()">Sign In Here!</a>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- /reset password -->
  </div><!-- /container -->

  <script src="components/jquery/dist/jquery.min.js"></script>
  <script src="components/js-cookie/src/js.cookie.js"></script>
  <script src='https://www.google.com/recaptcha/api.js?onload=onRecaptchaLoaded&render=explicit'></script>
  <script>
  $('#signinform').on('submit', function() {
    $.ajax({
      method: 'post',
      url: '/api/users/login',
      data: {
        email: $('#signin-username').val(),
        password: $('#signin-password').val()
      }
    }).done(function(data, status, xhr) {
      var expires = document.querySelector('#signin-remember').checked ? 7 : '';
      Cookies.set('access_token', data.id, {
        expires: expires
      });
      Cookies.set('userId', data.userId, {
        expires: expires
      });
      $('#signinalert').html('<strong>Sign-in success! Proceeding...</strong>');
      $('#signinalert').removeClass('alert-danger').addClass('alert-success').fadeIn(function() {
        setTimeout(function() {
          location.href = '/index.html';
        }, 500);
      });
    }).fail(function(xhr, status, error) {
      console.log('signin error: ' + xhr.responseJSON.error.message);
      $('#signinalert').html('<strong>Incorrect email or password.</strong>');
      $('#signinalert').removeClass('alert-success').addClass('alert-danger').fadeIn();
      Cookies.remove('access_token');
      Cookies.remove('userId');
    });
  });

  $('#signupform').on('submit', function() {
    $.ajax({
      method: 'post',
      url: '/api/users',
      data: {
        email: $('#signup-email').val(),
        givenName: $('#signup-lastname').val(),
        familyName: $('#signup-firstname').val(),
        password: $('#signup-passwd').val(),
        'g-recaptcha-response': document.querySelector('#g-recaptcha-response').value
      }
    }).done(function(data, status, xhr) {
      grecaptcha.reset();
      $('#signupalert').html('<strong>Signed up successfully!</strong><p>Please check your email and click on the verification link before logging in.</p>');
      $('#signupalert').removeClass('alert-danger').addClass('alert-success').fadeIn(function() {});
      $('#signupform')[0].reset();
      $('#signupform .input-group, #recaptchaDiv, #btn-signup').hide();
    }).fail(function(xhr, status, error) {
      var errMsg = xhr.responseJSON.error.message;
      console.log('signup error: ' + errMsg);
      if (errMsg === 'The response parameter is missing.') {
        var msg = 'Please verify that you are not a robot.';
      } else if (xhr.responseJSON.error.status === 422) {
        grecaptcha.reset();
        var msg = 'Email already exists.';
      } else {
        grecaptcha.reset();
        var msg = 'Signup failed.';
      }
      $('#signupalert').html('<strong>' + msg + '</strong>');
      $('#signupalert').removeClass('alert-success').addClass('alert-danger').fadeIn();
    });
  });

  $('#resetform').on('submit', function() {
    $.ajax({
      method: 'post',
      url: '/request-password-reset',
      data: {
        email: $('#reset-email').val()
      }
    }).done(function(data, status, xhr) {
      $('#resetalert').html('<strong>Password reset requested!</strong><p>Check your email for further instructions.</p>');
      $('#resetalert').removeClass('alert-danger').addClass('alert-success').fadeIn(function() {});
    }).fail(function(xhr, status, error) {
      $('#resetalert').html('<strong>' + xhr.responseJSON.error.message + '</strong>');
      $('#resetalert').removeClass('alert-success').addClass('alert-danger').fadeIn();
    });
  });

  var access_token = Cookies.get('access_token'),
    userId = Cookies.get('userId');

  if (access_token && userId) {
    location.href = '/index.html';
  }

  function toggleSignIn() {
    $('#signupalert').hide();
    $('#signupbox').hide();
    $('#resetpass').hide();
    $('#signinbox').show();
    document.title = 'Sign In - Webduino Device';
  }

  function toggleSignUp() {
    $('#signinalert').hide();
    $('#signinbox').hide();
    $('#resetpass').hide();
    $('#signupbox').show();
    $('#signupform .input-group, #recaptchaDiv, #btn-signup').show();
    document.title = 'Sign Up - Webduino Device';
  }

  function toggleResetPass() {
    $('#signinalert').hide();
    $('#signinbox').hide();
    $('#signupbox').hide();
    $('#resetpass').show();
    document.title = 'Reset Password - Webduino Device';
  }

  function onRecaptchaLoaded() {
    grecaptcha.render('recaptchaDiv', {
      'sitekey': '6LcNOssSAAAAACadwldL-4tZZAuoLCDUTegZRnh0',
      'theme': 'light'
    });
  }
  </script>
</body>

</html>
